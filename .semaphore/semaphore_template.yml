version: v1.0
name: "Backup Dinâmico de Banco de Dados"

parameters:
  - name: DATABASE_ENTRIES
    type: string
  - name: DST_DB_HOST
    type: string
  - name: DST_DB_PORT
    type: string
    default: "5432"
  - name: DST_DB_USER
    type: string
  - name: DST_DB_PASSWORD
    type: string
  - name: BACKUP_DEST_PATH
    type: string
    default: "/tmp/backups"

blocks:
  - name: "Executar Backup"
    task:
      # Vincula os secrets armazenados no Semaphore
      secrets:
        - name: db-secrets

      # Define variáveis de ambiente com base nos parâmetros e secrets
      env_vars:
        - name: DATABASE_ENTRIES
          value: "{{ parameters.DATABASE_ENTRIES }}"
        - name: DST_DB_HOST
          value: "{{ parameters.DST_DB_HOST }}"
        - name: DST_DB_PORT
          value: "{{ parameters.DST_DB_PORT }}"
        - name: DST_DB_USER
          value: "{{ parameters.DST_DB_USER }}"
        - name: DST_DB_PASSWORD
          value: "{{ parameters.DST_DB_PASSWORD }}"
        - name: BACKUP_DEST_PATH
          value: "{{ parameters.BACKUP_DEST_PATH }}"

      jobs:
        - name: "Executar Script"
          commands:
            - apt-get update
            - apt-get install -y postgresql-client
            - chmod +x teste/backup.sh     # <- Corrigido o caminho
            - ./teste/backup.sh
